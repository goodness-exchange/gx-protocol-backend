# Frontend-Backend Integration Status & MVP Alignment

**Date:** 2025-11-24
**Frontend:** gx-wallet-frontend (Next.js 14)
**Backend:** gx-protocol-backend (Node.js/TypeScript)
**Purpose:** Assess current state and align with MVP Implementation Plan

---

## Executive Summary

‚úÖ **Good News:**
- Frontend **already has** an admin dashboard with user management UI
- Next.js API routes proxy to backend services
- Admin dashboard supports: approve, deny, lock, unlock, process queue
- User registration and KYC forms exist

‚ö†Ô∏è **Gaps for MVP:**
- Gender field missing from KYC form
- Fabric User ID generation not implemented (uses old ID system)
- Batch registration incomplete
- Backend APIs need to be created (currently Next.js routes are proxies)
- Status state machine doesn't match new architecture

---

## Current Frontend Structure

### Admin Dashboard Location
```
/home/sugxcoin/prod-blockchain/gx-wallet-frontend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (root)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx          # Main admin dashboard
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (client)/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ page.tsx          # User dashboard
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ admin/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ approve-user/route.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pending-users/route.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ process-queue/route.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ unlock-account/route.ts
‚îÇ       ‚îú‚îÄ‚îÄ auth/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ register/route.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ login/route.ts
‚îÇ       ‚îî‚îÄ‚îÄ users/
‚îÇ           ‚îî‚îÄ‚îÄ me/route.ts
```

### Current Admin Dashboard Features

**UI Components:**
- Tab-based filtering: Pending, Approved, Active On-Chain, Locked, All Users
- User table with columns: Name, Email, On-Chain ID, Status, Actions
- Action buttons: Approve, Deny, Lock, Unlock, View Doc
- "Process On-Chain Queue" button for batch registration

**User Status Flow (Current):**
```
pending_admin_approval
  ‚Üí verified (after approval)
  ‚Üí active_on_chain (after blockchain registration)
  ‚Üí locked (if admin locks)
```

**API Endpoints (Next.js Proxy):**
- `GET /api/v1/admin/users?status={status}` - List users
- `POST /api/v1/admin/users/:id/approve` - Approve KYC
- `POST /api/v1/admin/users/:id/deny` - Deny KYC
- `POST /api/v1/admin/users/:id/lock` - Lock account
- `POST /api/v1/admin/accounts/:fabricUserId/unlock` - Unlock account
- `POST /api/v1/admin/process-queue` - Batch on-chain registration

---

## Alignment with MVP Architecture

### ‚úÖ What Matches MVP Plan

1. **Admin Dashboard UI** - Already exists and looks good
2. **User List with Filters** - Tabs for different statuses
3. **Approve/Deny Actions** - Buttons implemented
4. **Lock/Unlock Actions** - Buttons implemented
5. **KYC Document Viewing** - "View Doc" button
6. **Batch Registration** - "Process Queue" button

### ‚ùå What Needs MVP Updates

#### 1. **User Status State Machine Mismatch**

**Current Frontend States:**
```typescript
type TabStatus = 'pending_admin_approval' | 'all' | 'active_on_chain' | 'locked' | 'verified';
```

**MVP Architecture States:**
```typescript
enum UserStatus {
  REGISTERED
  PENDING_ADMIN_APPROVAL
  APPROVED_PENDING_ONCHAIN  // ‚Üê Missing in frontend!
  DENIED                     // ‚Üê Missing in frontend!
  ACTIVE
  FROZEN                     // ‚Üê Frontend calls it "locked"
}
```

**Fix Required:** Update frontend to match backend status enum

#### 2. **Gender Field Missing**

**Current User Interface (frontend):**
```typescript
interface User {
  id: string;
  fname: string;
  lname: string;
  username: string;
  email: string;
  country: string;         // Should be "nationality"
  status: string;
  createdAt: string;
  kycDocumentPath?: string;
  fabricUserId?: string;
  // ‚ùå MISSING: gender field
  // ‚ùå MISSING: dateOfBirth field
}
```

**MVP Architecture Requires:**
```typescript
interface UserProfile {
  // ... existing fields
  dateOfBirth: DateTime;
  gender: "male" | "female";  // Required for ID generation
  nationality: string;        // ISO country code
}
```

**Fix Required:** Add gender and dateOfBirth to KYC form and User interface

#### 3. **Fabric User ID Generation**

**Current:** Frontend expects `fabricUserId` to already exist or be generated by old backend

**MVP:** Backend generates deterministic ID during approval:
```typescript
// On approval button click ‚Üí backend generates:
const fabricUserId = generateFabricUserId(
  user.nationality,  // "US"
  user.dateOfBirth,  // "1989-05-15"
  user.gender,       // "female"
  "0"                // Account type: Individual
);
// Result: "US A3F HBF934 0ABCD 1234"
```

**Fix Required:** Backend API must generate ID on approval, frontend displays it

#### 4. **Backend API Proxying**

**Current:** Next.js API routes proxy to `https://api.gxcoin.money`

**Example (approve-user/route.ts):**
```typescript
export async function POST(request: Request) {
  // Next.js route proxies to backend
  const response = await fetch(`${BACKEND_URL}/api/gxcoin/admin/users/${userId}/approve`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response;
}
```

**MVP:** Need actual backend implementation in `gx-protocol-backend/apps/svc-admin/`

**Fix Required:** Implement real backend APIs (not just proxies)

---

## MVP Implementation Tasks - Frontend

### Phase 1: Update User Interface & Forms

**Files to Update:**

1. **Add Gender to KYC Form**
   - Location: `app/(root)/(client)/kyc/page.tsx` (or wherever KYC form is)
   - Add radio buttons: "Male" / "Female"
   - Add date picker for Date of Birth
   - Update form validation

2. **Update User Type Interface**
   - Location: `types/user.ts` or inline in dashboard
   - Add: `gender: "male" | "female"`
   - Add: `dateOfBirth: string`
   - Rename: `country` ‚Üí `nationality`

3. **Update Admin Dashboard Types**
   - Location: `app/(root)/admin/dashboard/page.tsx`
   - Update User interface (lines 10-21)
   - Add new status tabs: "Approved (Pending On-Chain)", "Denied"

### Phase 2: Update Status State Machine

**File:** `app/(root)/admin/dashboard/page.tsx`

**Changes:**
```typescript
// OLD
type TabStatus = 'pending_admin_approval' | 'all' | 'active_on_chain' | 'locked' | 'verified';

// NEW (align with backend)
type TabStatus =
  | 'REGISTERED'
  | 'PENDING_ADMIN_APPROVAL'
  | 'APPROVED_PENDING_ONCHAIN'
  | 'DENIED'
  | 'ACTIVE'
  | 'FROZEN'
  | 'all';

// Update tab buttons
<TabButton status="PENDING_ADMIN_APPROVAL" label="Pending Review" />
<TabButton status="APPROVED_PENDING_ONCHAIN" label="Approved (Queue)" />
<TabButton status="ACTIVE" label="Active On-Chain" />
<TabButton status="FROZEN" label="Frozen" />
<TabButton status="DENIED" label="Denied" />
<TabButton status="all" label="All Users" />
```

### Phase 3: Update API Calls

**Files to Update:**

1. **Approve User Action**
   - Location: `app/(root)/admin/dashboard/page.tsx` (line 195-198)
   - Change endpoint from `/api/gxcoin/admin/users/:id/approve`
   - To: `/api/v1/admin/users/:userId/approve`
   - Update response to expect: `{ fabricUserId: "US A3F..." }`

2. **Deny User Action**
   - Add to dashboard (currently missing deny button logic)
   - Endpoint: `POST /api/v1/admin/users/:userId/deny`
   - Body: `{ reason: "..." }`

3. **Batch Registration**
   - Location: Line 267 (handleProcessQueue)
   - Change from `/api/gxcoin/admin/process-queue`
   - To: `POST /api/v1/admin/users/batch-register-onchain`
   - Body: `{ userIds: [...] }`

4. **Freeze/Unfreeze (rename from Lock/Unlock)**
   - Change "Lock" ‚Üí "Freeze"
   - Change "Unlock" ‚Üí "Unfreeze"
   - Endpoints:
     - `POST /api/v1/admin/users/:userId/freeze`
     - `POST /api/v1/admin/users/:userId/unfreeze`

### Phase 4: Display Fabric User ID Format

**File:** `app/(root)/admin/dashboard/page.tsx`

**Update On-Chain ID Display:**
```typescript
// OLD (line 396)
<td className="p-3 font-mono text-xs">{user.fabricUserId || 'N/A'}</td>

// NEW (make it readable with proper spacing)
<td className="p-3 font-mono text-xs whitespace-nowrap">
  {user.fabricUserId || (
    <span className="text-gray-400">Not generated</span>
  )}
</td>

// Add tooltip explaining format
<td className="p-3 font-mono text-xs" title={user.fabricUserId ?
  `Country: ${user.fabricUserId.split(' ')[0]}\nChecksum: ${user.fabricUserId.split(' ')[1]}\nDOB+Gender: ${user.fabricUserId.split(' ')[2]}\nType+Random: ${user.fabricUserId.split(' ')[3]}\nSuffix: ${user.fabricUserId.split(' ')[4]}`
  : ''}>
  {user.fabricUserId || 'N/A'}
</td>
```

---

## MVP Implementation Tasks - Backend

### Phase 1: Create Real Backend APIs

**Location:** `gx-protocol-backend/apps/svc-admin/src/`

**Files to Create:**

1. **routes/admin.routes.ts**
```typescript
import { Router } from 'express';
import * as adminController from '../controllers/admin.controller';

const router = Router();

// User management
router.get('/users', adminController.listUsers);
router.get('/users/:userId', adminController.getUserDetails);
router.post('/users/:userId/approve', adminController.approveUser);
router.post('/users/:userId/deny', adminController.denyUser);

// Batch operations
router.get('/users/pending-onchain', adminController.getPendingOnchainUsers);
router.post('/users/batch-register-onchain', adminController.batchRegisterOnchain);

// Account management
router.post('/users/:userId/freeze', adminController.freezeUser);
router.post('/users/:userId/unfreeze', adminController.unfreezeUser);
router.get('/users/frozen', adminController.listFrozenUsers);

export default router;
```

2. **controllers/admin.controller.ts**
```typescript
import { Request, Response } from 'express';
import * as adminService from '../services/admin.service';

export async function approveUser(req: Request, res: Response) {
  try {
    const { userId } = req.params;
    const { notes } = req.body;
    const adminId = req.user.id; // From JWT

    const result = await adminService.approveUser(userId, adminId, notes);

    res.json({
      success: true,
      message: 'User approved successfully',
      fabricUserId: result.fabricUserId,
      status: result.status
    });
  } catch (error) {
    res.status(400).json({
      success: false,
      message: error.message
    });
  }
}

// ... other controller functions
```

3. **services/admin.service.ts**
```typescript
import { prisma } from '@gx/core-db';
import { generateFabricUserId } from '@gx/core-fabric/id-generator';

export async function approveUser(
  userId: string,
  adminId: string,
  notes?: string
) {
  // Get user
  const user = await prisma.userProfile.findUnique({
    where: { id: userId }
  });

  if (!user || user.status !== 'PENDING_ADMIN_APPROVAL') {
    throw new Error('User not eligible for approval');
  }

  // Validate required fields
  if (!user.nationality || !user.dateOfBirth || !user.gender) {
    throw new Error('Missing required fields for ID generation');
  }

  // Generate Fabric User ID
  const fabricUserId = generateFabricUserId(
    user.nationality,
    user.dateOfBirth.toISOString().split('T')[0],
    user.gender,
    '0' // Individual account type
  );

  // Update user
  const updated = await prisma.userProfile.update({
    where: { id: userId },
    data: {
      status: 'APPROVED_PENDING_ONCHAIN',
      fabricUserId,
      reviewedBy: adminId,
      reviewedAt: new Date()
    }
  });

  return {
    fabricUserId: updated.fabricUserId,
    status: updated.status
  };
}

// ... other service functions
```

### Phase 2: Implement ID Generator

**Location:** `gx-protocol-backend/packages/core-fabric/src/id-generator.ts`

**Create file with full implementation from architecture doc:**
```typescript
import crypto from 'crypto';

const BASE_DATE = new Date("1900-01-01");
const GENDER_OFFSET = 500000;
const ORG_OFFSET = 1000000;

const ACCOUNT_TYPES = {
  '0': "Individuals",
  '1': "For-profit Businesses",
  // ... (full list from architecture)
};

export function generateFabricUserId(
  countryCode: string,
  dob: string,
  gender: string,
  accountType: string
): string {
  // Full implementation from architecture doc
  // ...
}

export function decodeFabricUserId(uid: string): {
  countryCode: string;
  dateOfBirth: string;
  gender: string;
  // ...
} {
  // Full implementation from architecture doc
  // ...
}
```

### Phase 3: Update Database Schema

**Location:** `gx-protocol-backend/db/schema.prisma`

**Add missing fields:**
```prisma
model UserProfile {
  // ... existing fields

  // Add these:
  gender          String?     // "male" or "female"

  // Ensure these exist:
  dateOfBirth     DateTime?
  nationality     String?     // ISO 3166-1 alpha-2
}
```

**Run migration:**
```bash
cd gx-protocol-backend
npx prisma migrate dev --name add_gender_field
```

---

## API Endpoint Mapping

### Frontend ‚Üí Backend URL Mapping

| Frontend Call | Backend Endpoint | Status |
|--------------|------------------|--------|
| `GET /api/v1/admin/users?status=pending` | `GET /api/v1/admin/users?status=PENDING_ADMIN_APPROVAL` | ‚ö†Ô∏è Need to implement |
| `POST /api/v1/admin/users/:id/approve` | `POST /api/v1/admin/users/:userId/approve` | ‚ö†Ô∏è Need to implement |
| `POST /api/v1/admin/users/:id/deny` | `POST /api/v1/admin/users/:userId/deny` | ‚ö†Ô∏è Need to implement |
| `POST /api/v1/admin/users/:id/freeze` | `POST /api/v1/admin/users/:userId/freeze` | ‚ö†Ô∏è Need to implement |
| `POST /api/v1/admin/users/:id/unfreeze` | `POST /api/v1/admin/users/:userId/unfreeze` | ‚ö†Ô∏è Need to implement |
| `POST /api/v1/admin/process-queue` | `POST /api/v1/admin/users/batch-register-onchain` | ‚ö†Ô∏è Need to implement |

---

## Development Workflow

### Step 1: Backend First
1. Create `id-generator.ts` with unit tests
2. Update Prisma schema and run migration
3. Implement admin APIs in `svc-admin`
4. Test with Postman/curl

### Step 2: Frontend Updates
1. Add gender field to KYC form
2. Update User interface types
3. Update status state machine
4. Update API endpoint URLs
5. Test admin dashboard flows

### Step 3: Integration Testing
1. Register user ‚Üí Submit KYC (with gender)
2. Admin approves ‚Üí Backend generates Fabric ID
3. Admin triggers batch registration
4. User becomes ACTIVE on-chain
5. Admin can freeze/unfreeze

---

## Testing Checklist

### Backend API Testing
- [ ] POST /api/v1/admin/users/:userId/approve
  - Returns fabricUserId in correct format
  - Status updates to APPROVED_PENDING_ONCHAIN
- [ ] POST /api/v1/admin/users/:userId/deny
  - Status updates to DENIED
  - Reason stored correctly
- [ ] GET /api/v1/admin/users/pending-onchain
  - Returns all APPROVED_PENDING_ONCHAIN users
- [ ] POST /api/v1/admin/users/batch-register-onchain
  - Creates OutboxCommands
  - Returns 202 Accepted
- [ ] POST /api/v1/admin/users/:userId/freeze
  - Updates status to FROZEN
  - Creates OutboxCommand
- [ ] POST /api/v1/admin/users/:userId/unfreeze
  - Updates status to ACTIVE
  - Creates OutboxCommand

### Frontend UI Testing
- [ ] Admin dashboard loads users correctly
- [ ] Tabs filter by status (5 tabs)
- [ ] Approve button generates and displays Fabric ID
- [ ] Deny button prompts for reason
- [ ] Freeze button changes status
- [ ] Unfreeze button restores access
- [ ] Batch registration button triggers queue processing
- [ ] KYC form includes gender field
- [ ] Fabric ID displays with proper spacing

---

## Next Steps

1. **Backend Implementation** (Week 1-2)
   - Create `id-generator.ts`
   - Implement admin controller/service
   - Add database migration
   - Write unit tests

2. **Frontend Updates** (Week 2)
   - Add gender to KYC form
   - Update admin dashboard status tabs
   - Update API endpoint URLs
   - Test UI flows

3. **Integration** (Week 3)
   - Deploy backend APIs
   - Update frontend to point to new APIs
   - End-to-end testing

4. **Blockchain** (Week 3-4)
   - Add FreezeUser/UnfreezeUser functions
   - Update projector event handlers
   - Test freeze/unfreeze flows

---

## Summary

**Frontend Status:** üü° 70% Complete
- ‚úÖ Admin dashboard UI exists
- ‚úÖ User table and filters
- ‚úÖ Action buttons (approve, deny, lock, unlock)
- ‚ùå Gender field missing
- ‚ùå Status state machine mismatch
- ‚ùå Fabric ID generation not implemented

**Backend Status:** üî¥ 30% Complete
- ‚úÖ Database schema (mostly)
- ‚úÖ Outbox/projector pattern
- ‚ùå Admin APIs not implemented
- ‚ùå ID generator not implemented
- ‚ùå Freeze/unfreeze chaincode functions missing

**Overall MVP Readiness:** üü° 50% Complete

**Estimated Time to MVP:** 3-4 weeks with focused effort on backend APIs and frontend alignment.

