# ğŸ¨ Visual Architecture Guide

This document contains visual diagrams to help you understand the GX Protocol Backend architecture.

---

## 1. The Big Picture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                           USERS (Mobile/Web Apps)                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTPS/REST API
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                        API LAYER (HTTP Services)                            â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚                 â”‚
â”‚  â”‚  svc-        â”‚    â”‚  svc-        â”‚    â”‚  svc-        â”‚                 â”‚
â”‚  â”‚  identity    â”‚    â”‚  tokenomics  â”‚    â”‚  governance  â”‚    + more...    â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚                 â”‚
â”‚  â”‚  :3001       â”‚    â”‚  :3002       â”‚    â”‚  :3003       â”‚                 â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                   â”‚                   â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                             â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Reads/Writes
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                     SHARED PACKAGES (Libraries)                             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  core-   â”‚  â”‚  core-   â”‚  â”‚  core-   â”‚  â”‚  core-   â”‚  â”‚  core-   â”‚    â”‚
â”‚  â”‚  config  â”‚  â”‚  logger  â”‚  â”‚  db      â”‚  â”‚  http    â”‚  â”‚  openapi â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Database Operations
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                        DATABASE (PostgreSQL)                                â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WRITE MODELS       â”‚  â”‚  READ MODELS        â”‚  â”‚  INFRASTRUCTURE  â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚  â”‚                  â”‚   â”‚
â”‚  â”‚  â€¢ outbox_commands  â”‚  â”‚  â€¢ user_profiles    â”‚  â”‚  â€¢ projector_    â”‚   â”‚
â”‚  â”‚    (pending writes) â”‚  â”‚  â€¢ wallets          â”‚  â”‚    state         â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚  â€¢ transactions     â”‚  â”‚  â€¢ http_         â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚  â€¢ beneficiaries    â”‚  â”‚    idempotency   â”‚   â”‚
â”‚  â”‚                     â”‚  â”‚  â€¢ licenses         â”‚  â”‚  â€¢ event_log     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                         â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                         â†‘
             â”‚ Polls for               â”‚ Writes
             â”‚ PENDING                 â”‚ updates
             â†“                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚      â”‚                     â”‚
â”‚  OUTBOX-SUBMITTER   â”‚      â”‚     PROJECTOR       â”‚
â”‚     (Worker)        â”‚      â”‚     (Worker)        â”‚
â”‚                     â”‚      â”‚                     â”‚
â”‚  â€¢ Polls every 5s   â”‚      â”‚  â€¢ Listens to       â”‚
â”‚  â€¢ Locks commands   â”‚      â”‚    Fabric events    â”‚
â”‚  â€¢ Submits to chain â”‚      â”‚  â€¢ Updates read     â”‚
â”‚  â€¢ Handles retries  â”‚      â”‚    models           â”‚
â”‚                     â”‚      â”‚  â€¢ Checkpoints      â”‚
â”‚                     â”‚      â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                            â†‘
           â”‚ Submits                    â”‚ Listens
           â”‚ Transactions               â”‚ to Events
           â”‚                            â”‚
           â†“                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                    HYPERLEDGER FABRIC (Blockchain)                          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Chaincode     â”‚  â”‚   Chaincode     â”‚  â”‚   Chaincode     â”‚            â”‚
â”‚  â”‚   (Identity)    â”‚  â”‚   (Tokenomics)  â”‚  â”‚   (Governance)  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                             â”‚
â”‚  Stores: Immutable ledger, User IDs, Balances, Transfers, Votes            â”‚
â”‚  Emits: Events on every state change                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Request Flow: User Registration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER REGISTRATION FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: User Sends Request
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚  POST /api/v1/users
â”‚ (Alice) â”‚  {
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    "email": "alice@example.com",
     â”‚         "firstName": "Alice",
     â”‚         "password": "secure123"
     â”‚       }
     â”‚
     â†“


STEP 2: API Service Processes Request
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         svc-identity (:3001)               â”‚
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. OpenAPI Middleware                â”‚ â”‚
â”‚  â”‚    âœ“ Validate request schema         â”‚ â”‚
â”‚  â”‚    âœ“ Check required fields           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 2. Request Logger Middleware         â”‚ â”‚
â”‚  â”‚    ğŸ“ Log: POST /users - Started     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 3. Idempotency Middleware            â”‚ â”‚
â”‚  â”‚    âœ“ Check if duplicate request      â”‚ â”‚
â”‚  â”‚    âœ“ First time? Continue            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 4. Controller                        â”‚ â”‚
â”‚  â”‚    â€¢ Extract request data            â”‚ â”‚
â”‚  â”‚    â€¢ Call service layer              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 5. Service Layer                     â”‚ â”‚
â”‚  â”‚    â€¢ Hash password (bcrypt)          â”‚ â”‚
â”‚  â”‚    â€¢ Generate request ID             â”‚ â”‚
â”‚  â”‚    â€¢ Call repository                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 6. Repository Layer                  â”‚ â”‚
â”‚  â”‚    await prisma.$transaction([       â”‚ â”‚
â”‚  â”‚      // Write to outbox              â”‚ â”‚
â”‚  â”‚      prisma.outboxCommand.create({   â”‚ â”‚
â”‚  â”‚        commandType: 'CREATE_USER',   â”‚ â”‚
â”‚  â”‚        payload: {...},               â”‚ â”‚
â”‚  â”‚        status: 'PENDING'             â”‚ â”‚
â”‚  â”‚      }),                             â”‚ â”‚
â”‚  â”‚      // Save idempotency record      â”‚ â”‚
â”‚  â”‚      prisma.httpIdempotency.create() â”‚ â”‚
â”‚  â”‚    ])                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 7. Response                          â”‚ â”‚
â”‚  â”‚    HTTP 202 Accepted                 â”‚ â”‚
â”‚  â”‚    {                                 â”‚ â”‚
â”‚  â”‚      "requestId": "abc-123",         â”‚ â”‚
â”‚  â”‚      "status": "pending"             â”‚ â”‚
â”‚  â”‚    }                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Response (< 20ms)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚  âœ“ "Registration in progress..."
â”‚ (Alice) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 3: Database State
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL Database             â”‚
â”‚                                         â”‚
â”‚  outbox_commands:                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ id: "cmd-001"                       â”‚â”‚
â”‚  â”‚ commandType: "CREATE_USER"          â”‚â”‚
â”‚  â”‚ payload: {                          â”‚â”‚
â”‚  â”‚   email: "alice@example.com",       â”‚â”‚
â”‚  â”‚   firstName: "Alice",               â”‚â”‚
â”‚  â”‚   passwordHash: "$2b$10$..."        â”‚â”‚
â”‚  â”‚ }                                   â”‚â”‚
â”‚  â”‚ status: "PENDING"  â† Ready!         â”‚â”‚
â”‚  â”‚ requestId: "abc-123"                â”‚â”‚
â”‚  â”‚ createdAt: 2025-10-15T10:30:00Z     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  http_idempotency:                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ method: "POST"                      â”‚â”‚
â”‚  â”‚ path: "/api/v1/users"               â”‚â”‚
â”‚  â”‚ bodyHash: "sha256..."               â”‚â”‚
â”‚  â”‚ responseBody: { requestId: "..." }  â”‚â”‚
â”‚  â”‚ statusCode: 202                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 4: Worker Picks Up Command (5 seconds later)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       outbox-submitter (Worker)             â”‚
â”‚                                             â”‚
â”‚  â° Timer triggers (every 5 seconds)        â”‚
â”‚                                             â”‚
â”‚  1. Query Database:                         â”‚
â”‚     SELECT * FROM outbox_commands           â”‚
â”‚     WHERE status = 'PENDING'                â”‚
â”‚     LIMIT 10                                â”‚
â”‚     FOR UPDATE SKIP LOCKED                  â”‚
â”‚                                             â”‚
â”‚  2. Lock Command:                           â”‚
â”‚     UPDATE status = 'LOCKED'                â”‚
â”‚     WHERE id = 'cmd-001'                    â”‚
â”‚                                             â”‚
â”‚  3. Submit to Fabric:                       â”‚
â”‚     fabricClient.submitTransaction(         â”‚
â”‚       'createUser',                         â”‚
â”‚       JSON.stringify(payload)               â”‚
â”‚     )                                       â”‚
â”‚                                             â”‚
â”‚  4. Update Status:                          â”‚
â”‚     UPDATE status = 'SUBMITTED'             â”‚
â”‚     SET fabricTxId = 'tx-xyz-789'           â”‚
â”‚     WHERE id = 'cmd-001'                    â”‚
â”‚                                             â”‚
â”‚  ğŸ“ Log: "Submitted CREATE_USER to Fabric"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ submitTransaction()
     â†“


STEP 5: Blockchain Processes Transaction
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Hyperledger Fabric (Blockchain)        â”‚
â”‚                                             â”‚
â”‚  1. Receive transaction from worker         â”‚
â”‚                                             â”‚
â”‚  2. Execute chaincode:                      â”‚
â”‚     function createUser(email, firstName) { â”‚
â”‚       // Validate user doesn't exist        â”‚
â”‚       // Generate blockchain user ID        â”‚
â”‚       // Store on ledger                    â”‚
â”‚       const userId = 'fabric-user-123';     â”‚
â”‚       emit('UserCreated', {                 â”‚
â”‚         userId,                             â”‚
â”‚         email,                              â”‚
â”‚         firstName,                          â”‚
â”‚         txId: 'tx-xyz-789'                  â”‚
â”‚       });                                   â”‚
â”‚     }                                       â”‚
â”‚                                             â”‚
â”‚  3. Consensus & Commit (~2 seconds)         â”‚
â”‚                                             â”‚
â”‚  4. Emit Event:                             â”‚
â”‚     Event: "UserCreated"                    â”‚
â”‚     {                                       â”‚
â”‚       userId: "fabric-user-123",            â”‚
â”‚       email: "alice@example.com",           â”‚
â”‚       firstName: "Alice",                   â”‚
â”‚       txId: "tx-xyz-789",                   â”‚
â”‚       blockNumber: 12345,                   â”‚
â”‚       timestamp: "2025-10-15T10:30:07Z"     â”‚
â”‚     }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Event Stream
     â†“


STEP 6: Projector Hears Event
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          projector (Worker)                  â”‚
â”‚                                              â”‚
â”‚  ğŸ§ Listening to Fabric event stream...      â”‚
â”‚                                              â”‚
â”‚  1. Receive "UserCreated" event              â”‚
â”‚                                              â”‚
â”‚  2. Validate event schema:                   â”‚
â”‚     userCreatedSchema.parse(event.payload)   â”‚
â”‚     âœ“ Valid!                                 â”‚
â”‚                                              â”‚
â”‚  3. Update Database (Transaction):           â”‚
â”‚     await prisma.$transaction([              â”‚
â”‚       // Insert user profile (Read Model)    â”‚
â”‚       prisma.userProfile.create({            â”‚
â”‚         profileId: 'fabric-user-123',        â”‚
â”‚         email: 'alice@example.com',          â”‚
â”‚         firstName: 'Alice',                  â”‚
â”‚         status: 'VERIFIED'                   â”‚
â”‚       }),                                    â”‚
â”‚                                              â”‚
â”‚       // Update outbox status                â”‚
â”‚       prisma.outboxCommand.update({          â”‚
â”‚         where: { fabricTxId: 'tx-xyz-789' }, â”‚
â”‚         data: { status: 'COMMITTED' }        â”‚
â”‚       }),                                    â”‚
â”‚                                              â”‚
â”‚       // Insert event log (Audit)            â”‚
â”‚       prisma.eventLog.create({               â”‚
â”‚         fabricTxId: 'tx-xyz-789',            â”‚
â”‚         eventName: 'UserCreated',            â”‚
â”‚         payload: event,                      â”‚
â”‚         blockNumber: 12345                   â”‚
â”‚       }),                                    â”‚
â”‚                                              â”‚
â”‚       // Update checkpoint                   â”‚
â”‚       prisma.projectorState.upsert({         â”‚
â”‚         where: { projectorName: 'identity'}, â”‚
â”‚         update: {                            â”‚
â”‚           lastBlock: 12345,                  â”‚
â”‚           lastEventIndex: 0                  â”‚
â”‚         }                                    â”‚
â”‚       })                                     â”‚
â”‚     ])                                       â”‚
â”‚                                              â”‚
â”‚  ğŸ“ Log: "Processed UserCreated event"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 7: Database Updated
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL Database                 â”‚
â”‚                                             â”‚
â”‚  user_profiles: (NEW!)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ profileId: "fabric-user-123"         â”‚  â”‚
â”‚  â”‚ email: "alice@example.com"           â”‚  â”‚
â”‚  â”‚ firstName: "Alice"                   â”‚  â”‚
â”‚  â”‚ status: "VERIFIED"                   â”‚  â”‚
â”‚  â”‚ createdAt: 2025-10-15T10:30:07Z      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  outbox_commands: (UPDATED!)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ id: "cmd-001"                        â”‚  â”‚
â”‚  â”‚ status: "COMMITTED" âœ“ Done!          â”‚  â”‚
â”‚  â”‚ fabricTxId: "tx-xyz-789"             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  projector_state: (CHECKPOINT!)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ projectorName: "identity"            â”‚  â”‚
â”‚  â”‚ lastBlock: 12345                     â”‚  â”‚
â”‚  â”‚ lastEventIndex: 0                    â”‚  â”‚
â”‚  â”‚ updatedAt: 2025-10-15T10:30:08Z      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STEP 8: User Polls for Status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚  GET /api/v1/requests/abc-123/status
â”‚ (Alice) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         svc-identity (:3001)               â”‚
â”‚                                            â”‚
â”‚  1. Query Database:                        â”‚
â”‚     SELECT * FROM outbox_commands          â”‚
â”‚     WHERE requestId = 'abc-123'            â”‚
â”‚                                            â”‚
â”‚  2. Return status:                         â”‚
â”‚     HTTP 200 OK                            â”‚
â”‚     {                                      â”‚
â”‚       "requestId": "abc-123",              â”‚
â”‚       "status": "committed",               â”‚
â”‚       "userId": "fabric-user-123",         â”‚
â”‚       "completedAt": "2025-10-15T10:30:08Z"â”‚
â”‚     }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚  âœ“ "Registration successful!"
â”‚ (Alice) â”‚  âœ“ "Welcome, Alice!"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


TIMELINE SUMMARY:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T+0s:   User sends POST request
T+0.02s: API responds 202 Accepted (20ms)
T+5s:   Worker submits to blockchain
T+7s:   Blockchain confirms (2s consensus)
T+7.5s: Projector updates database
T+10s:  User polls and sees "committed" status

Total: 10 seconds (but user only waited 20ms!)
```

---

## 3. Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATABASE SCHEMA OVERVIEW                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


INFRASTRUCTURE TABLES (CQRS/Event-Driven)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  outbox_commands     â”‚  â† Commands waiting for blockchain
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id (PK)             â”‚
â”‚  tenantId            â”‚
â”‚  commandType         â”‚  (CREATE_USER, TRANSFER_TOKENS, etc.)
â”‚  payload (JSON)      â”‚  (Command data)
â”‚  status              â”‚  (PENDING â†’ LOCKED â†’ SUBMITTED â†’ COMMITTED)
â”‚  attempts            â”‚  (Retry count)
â”‚  fabricTxId          â”‚  (Blockchain transaction ID)
â”‚  createdAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  projector_state     â”‚  â† Event processing checkpoint
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  tenantId (PK)       â”‚
â”‚  projectorName (PK)  â”‚  (identity, tokenomics, etc.)
â”‚  channel (PK)        â”‚  (Fabric channel name)
â”‚  lastBlock           â”‚  (Last processed block number)
â”‚  lastEventIndex      â”‚  (Last event in that block)
â”‚  updatedAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  http_idempotency    â”‚  â† Prevent duplicate requests
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  tenantId (PK)       â”‚
â”‚  method (PK)         â”‚  (POST, PUT, etc.)
â”‚  path (PK)           â”‚  (/api/v1/users)
â”‚  bodyHash (PK)       â”‚  (SHA256 of request body)
â”‚  responseBody (JSON) â”‚  (Cached response)
â”‚  statusCode          â”‚
â”‚  createdAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  event_log           â”‚  â† Audit trail of all events
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id (PK)             â”‚
â”‚  tenantId            â”‚
â”‚  fabricTxId          â”‚
â”‚  blockNumber         â”‚
â”‚  eventName           â”‚  (UserCreated, TransferCompleted, etc.)
â”‚  payload (JSON)      â”‚
â”‚  txTimestamp         â”‚
â”‚  ingestedAt          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  event_dlq           â”‚  â† Failed events (Dead-Letter Queue)
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id (PK)             â”‚
â”‚  tenantId            â”‚
â”‚  reason              â”‚  (Schema validation failed, etc.)
â”‚  rawPayload (JSON)   â”‚
â”‚  fabricTxId          â”‚
â”‚  createdAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


IDENTITY & KYC TABLES (Read Models)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  user_profiles       â”‚  â† Main user table
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  profileId (PK)      â”‚ â†â”€â”€â”€â”€â”€â”
â”‚  tenantId            â”‚       â”‚
â”‚  firstName           â”‚       â”‚
â”‚  lastName            â”‚       â”‚
â”‚  email (unique)      â”‚       â”‚
â”‚  phoneNum (unique)   â”‚       â”‚
â”‚  biometricHash       â”‚       â”‚
â”‚  passwordHash        â”‚       â”‚
â”‚  status              â”‚       â”‚ (PENDING_VERIFICATION, VERIFIED, REJECTED)
â”‚  createdAt           â”‚       â”‚
â”‚  updatedAt           â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                               â”‚ FK: profileId
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  kyc_verifications   â”‚ â”€â”€â”€â”€â”€â”€â”˜
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  kycId (PK)          â”‚
â”‚  profileId (FK)      â”‚
â”‚  status              â”‚  (PENDING, APPROVED, REJECTED)
â”‚  verifiedAt          â”‚
â”‚  evidenceHash        â”‚  (SHA256 of uploaded documents)
â”‚  evidenceSize        â”‚  (bytes)
â”‚  evidenceMime        â”‚  (image/jpeg, application/pdf)
â”‚  createdAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WALLET & TRANSACTION TABLES (Read Models)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  wallets             â”‚  â† User wallets (balances cached from blockchain)
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  walletId (PK)       â”‚ â†â”€â”€â”€â”€â”€â”
â”‚  tenantId            â”‚       â”‚
â”‚  profileId (FK)      â”‚ â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â†’ user_profiles.profileId
â”‚  primaryAccountId    â”‚       â”‚     (Blockchain account ID)
â”‚  walletName          â”‚       â”‚
â”‚  cachedBalance       â”‚       â”‚     (Read from blockchain events)
â”‚  createdAt           â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                               â”‚ FK: walletId
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  transactions        â”‚ â”€â”€â”€â”€â”€â”€â”˜
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  offTxId (PK)        â”‚
â”‚  tenantId            â”‚
â”‚  onChainTxId         â”‚  (Blockchain transaction ID)
â”‚  walletId (FK)       â”‚
â”‚  type                â”‚  (MINT, SENT, RECEIVED, TAX, etc.)
â”‚  counterparty        â”‚  (Other user's account ID)
â”‚  amount              â”‚
â”‚  fee                 â”‚
â”‚  remark              â”‚
â”‚  timestamp           â”‚  (Blockchain timestamp)
â”‚  blockNumber         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  beneficiaries       â”‚  â† Saved recipients (like "favorites")
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  beneficiaryId (PK)  â”‚
â”‚  tenantId            â”‚
â”‚  ownerProfileId (FK) â”‚ â”€â”€â”€â”€â†’ user_profiles.profileId
â”‚  beneficiaryId       â”‚       (Recipient's account ID)
â”‚  nickname            â”‚       ("Mom", "Boss", etc.)
â”‚  createdAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ORGANIZATION & LICENSING TABLES (Read Models)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  organization_       â”‚  â† Companies using the platform
â”‚  profiles            â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  orgProfileId (PK)   â”‚ â†â”€â”€â”€â”€â”€â”
â”‚  tenantId            â”‚       â”‚
â”‚  legalName           â”‚       â”‚
â”‚  registrationNumber  â”‚       â”‚
â”‚  jurisdictionCountry â”‚ â”€â”€â”   â”‚
â”‚  status              â”‚   â”‚   â”‚
â”‚  createdAt           â”‚   â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
                           â”‚   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  licensed_partners   â”‚   â”‚   â”‚ â† Partners (merchants, banks, etc.)
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚   â”‚
â”‚  partnerId (PK)      â”‚ â†â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
â”‚  tenantId            â”‚   â”‚   â”‚     â”‚
â”‚  companyName         â”‚   â”‚   â”‚     â”‚
â”‚  jurisdictionCountry â”‚ â”€â”€â”˜   â”‚     â”‚
â”‚  status              â”‚       â”‚     â”‚ (PENDING, ACTIVE, REVOKED)
â”‚  createdAt           â”‚       â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚     â”‚
                               â”‚     â”‚ FK: partnerId
                               â”‚     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚
â”‚  applications        â”‚ â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  appId (PK)          â”‚ â†â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
â”‚  tenantId            â”‚       â”‚     â”‚
â”‚  partnerId (FK)      â”‚       â”‚     â”‚
â”‚  appName             â”‚       â”‚     â”‚
â”‚  createdAt           â”‚       â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚     â”‚
                               â”‚     â”‚ FK: appId
                               â”‚     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚
â”‚  licenses            â”‚ â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚  licenseId (PK)      â”‚ â†â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
â”‚  tenantId            â”‚       â”‚     â”‚
â”‚  appId (FK)          â”‚       â”‚     â”‚
â”‚  licenseType         â”‚       â”‚     â”‚ (API_ACCESS, DISBURSEMENT, etc.)
â”‚  status              â”‚       â”‚     â”‚ (ACTIVE, EXPIRED, REVOKED)
â”‚  expiryDate          â”‚       â”‚     â”‚
â”‚  createdAt           â”‚       â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚     â”‚
                               â”‚     â”‚ FK: licenseId
                               â”‚     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚
â”‚  credentials         â”‚ â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  credentialId (PK)   â”‚
â”‚  tenantId            â”‚
â”‚  licenseId (FK)      â”‚
â”‚  clientId            â”‚  (API key ID)
â”‚  clientSecretHash    â”‚  (Hashed API secret)
â”‚  status              â”‚  (ACTIVE, REVOKED)
â”‚  createdAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


RELATIONSHIPS SUMMARY:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

user_profiles (1) â”€â†’ (N) kyc_verifications
user_profiles (1) â”€â†’ (N) wallets
wallets (1) â”€â†’ (N) transactions
user_profiles (1) â”€â†’ (N) beneficiaries

licensed_partners (1) â”€â†’ (N) applications
applications (1) â”€â†’ (N) licenses
licenses (1) â”€â†’ (N) credentials
```

---

## 4. Worker Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         OUTBOX-SUBMITTER WORKER                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  START (Timer)  â”‚  â† Runs every 5 seconds
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Query Database                 â”‚
  â”‚  SELECT * FROM outbox_commands  â”‚
  â”‚  WHERE status = 'PENDING'       â”‚
  â”‚  ORDER BY createdAt ASC         â”‚
  â”‚  LIMIT 10                       â”‚
  â”‚  FOR UPDATE SKIP LOCKED         â”‚ â† Prevents race conditions
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Any commands found?            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
   NO            YES
    â”‚             â”‚
    â†“             â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Sleep â”‚  â”‚ For each command...  â”‚
  â”‚  5s   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”¬â”€â”€â”€â”˜             â”‚
      â”‚                 â†“
      â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚        â”‚ Lock Command        â”‚
      â”‚        â”‚ UPDATE status =     â”‚
      â”‚        â”‚   'LOCKED',         â”‚
      â”‚        â”‚   lockedBy = 'w-1', â”‚
      â”‚        â”‚   lockedAt = NOW()  â”‚
      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                  â”‚
      â”‚                  â†“
      â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚        â”‚ Submit to Fabric    â”‚
      â”‚        â”‚ fabricClient        â”‚
      â”‚        â”‚   .submitTransactionâ”‚
      â”‚        â”‚   (type, payload)   â”‚
      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                  â”‚
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         â”‚                 â”‚
      â”‚      SUCCESS            FAIL
      â”‚         â”‚                 â”‚
      â”‚         â†“                 â†“
      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  â”‚ Update:     â”‚   â”‚ Update:         â”‚
      â”‚  â”‚ status =    â”‚   â”‚ attempts++      â”‚
      â”‚  â”‚  'SUBMITTED'â”‚   â”‚ error = msg     â”‚
      â”‚  â”‚ fabricTxId  â”‚   â”‚ status = 'FAIL' â”‚
      â”‚  â”‚  = txId     â”‚   â”‚   (if â‰¥3 tries) â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚         â”‚                 â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            PROJECTOR WORKER                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  START          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Get Last Checkpoint             â”‚
  â”‚ SELECT * FROM projector_state   â”‚
  â”‚ WHERE projectorName = 'identity'â”‚
  â”‚ â†’ lastBlock = 12340             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Connect to Fabric Event Stream  â”‚
  â”‚ fabricClient.registerListener({ â”‚
  â”‚   startBlock: 12341,            â”‚
  â”‚   endBlock: 'latest'            â”‚
  â”‚ })                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Listening for events...        â”‚
  â”‚  ğŸ§ (blocking, waiting)          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Event Received!                â”‚
  â”‚  {                              â”‚
  â”‚    eventName: "UserCreated",    â”‚
  â”‚    blockNumber: 12345,          â”‚
  â”‚    txId: "tx-xyz",              â”‚
  â”‚    payload: {...}               â”‚
  â”‚  }                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Validate Event Schema          â”‚
  â”‚  userCreatedSchema.parse()      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
  INVALID       VALID
    â”‚             â”‚
    â†“             â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Write to  â”‚  â”‚ Process Event       â”‚
  â”‚ event_dlq â”‚  â”‚ (Update database)   â”‚
  â”‚ (DLQ)     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
                           â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Start Transaction   â”‚
                  â”‚ prisma.$transaction â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Handle Event Type           â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚             â”‚             â”‚
              â†“             â†“             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UserCreated â”‚ â”‚ Transfer     â”‚ â”‚ Other        â”‚
    â”‚             â”‚ â”‚ Completed    â”‚ â”‚ Events...    â”‚
    â”‚ â€¢ INSERT    â”‚ â”‚              â”‚ â”‚              â”‚
    â”‚   user_     â”‚ â”‚ â€¢ UPDATE     â”‚ â”‚              â”‚
    â”‚   profiles  â”‚ â”‚   wallet     â”‚ â”‚              â”‚
    â”‚             â”‚ â”‚   balances   â”‚ â”‚              â”‚
    â”‚ â€¢ UPDATE    â”‚ â”‚ â€¢ INSERT     â”‚ â”‚              â”‚
    â”‚   outbox    â”‚ â”‚   transactionâ”‚ â”‚              â”‚
    â”‚   status    â”‚ â”‚ â€¢ UPDATE     â”‚ â”‚              â”‚
    â”‚             â”‚ â”‚   outbox     â”‚ â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚             â”‚             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ INSERT event_log    â”‚
                  â”‚ (Audit Trail)       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ UPDATE projector_   â”‚
                  â”‚ state (Checkpoint)  â”‚
                  â”‚ lastBlock = 12345   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Commit Transaction  â”‚
                  â”‚ (All or nothing!)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Log Success         â”‚
                  â”‚ ğŸ“ "Processed       â”‚
                  â”‚     UserCreated"    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Wait for next event â”‚
                  â”‚ ğŸ§ (listening...)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Error Handling & Resilience

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ERROR SCENARIOS & RECOVERY                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


SCENARIO 1: Outbox-Submitter Crashes Mid-Processing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Time 10:30:00 - Worker locks command
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  outbox_commands     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id: "cmd-001"       â”‚
â”‚  status: "LOCKED"    â”‚ â† Locked!
â”‚  lockedBy: "w-1"     â”‚
â”‚  lockedAt: 10:30:00  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time 10:30:01 - Worker CRASHES! ğŸ’¥

Time 10:31:00 - Stale lock cleanup (1 minute later)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Another worker or watchdog runs:    â”‚
â”‚                                       â”‚
â”‚  UPDATE outbox_commands               â”‚
â”‚  SET status = 'PENDING',              â”‚
â”‚      lockedBy = NULL,                 â”‚
â”‚      lockedAt = NULL                  â”‚
â”‚  WHERE status = 'LOCKED'              â”‚
â”‚    AND lockedAt < NOW() - INTERVAL    â”‚
â”‚        '1 minute'                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: Command retried by another worker! âœ“


SCENARIO 2: Fabric Submit Fails (Network Error)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Worker tries to submit:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  fabricClient.submitTransaction()    â”‚
â”‚  â†“                                   â”‚
â”‚  âŒ Error: ECONNREFUSED              â”‚
â”‚     (Fabric network down)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Worker updates outbox:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  outbox_commands     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id: "cmd-001"       â”‚
â”‚  status: "PENDING"   â”‚ â† Back to pending
â”‚  attempts: 1         â”‚ â† Increment
â”‚  error: "ECONNREFUSED"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Next cycle (5 seconds later):
â†’ Worker tries again (retry #2)
â†’ Max 3 retries, then status = 'FAILED'

Failed commands go to manual review or alert team.


SCENARIO 3: Projector Receives Invalid Event
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Fabric emits event:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Event: "UserCreated"                â”‚
â”‚  {                                   â”‚
â”‚    userId: "123",                    â”‚
â”‚    email: "invalid",  â† Not an email!â”‚
â”‚    firstName: null    â† Required!    â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Projector validates:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  userCreatedSchema.parse(payload)    â”‚
â”‚  â†“                                   â”‚
â”‚  âŒ ValidationError:                 â”‚
â”‚     - email must be valid email      â”‚
â”‚     - firstName is required          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Event sent to Dead-Letter Queue:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  event_dlq           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id: "dlq-001"       â”‚
â”‚  tenantId: "..."     â”‚
â”‚  reason: "Schema     â”‚
â”‚    validation failed"â”‚
â”‚  rawPayload: {...}   â”‚ â† Save for debugging
â”‚  fabricTxId: "tx-xyz"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Alert sent to ops team! ğŸš¨
Projector continues processing other events.


SCENARIO 4: Database Transaction Fails
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Projector starts transaction:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  prisma.$transaction([               â”‚
â”‚    prisma.userProfile.create(...),   â”‚
â”‚    prisma.outbox.update(...),        â”‚ â† Fails! (Constraint)
â”‚    prisma.eventLog.create(...),      â”‚
â”‚    prisma.projectorState.update(...) â”‚
â”‚  ])                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Database ROLLBACK:
â†’ ALL operations reverted!
â†’ userProfile NOT created
â†’ outbox NOT updated
â†’ eventLog NOT created
â†’ projectorState NOT updated

Projector:
â†’ Logs error
â†’ Moves to next event? NO!
â†’ STOPS processing (to preserve order)
â†’ Retries same event after delay

Why? Events must be processed IN ORDER to maintain consistency.


SCENARIO 5: Idempotent Request Handling
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

User clicks "Transfer" button twice:

Request 1 (10:30:00.000):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /transfers                     â”‚
â”‚  X-Idempotency-Key: "abc-123"        â”‚
â”‚  { from: "alice", to: "bob",         â”‚
â”‚    amount: 100 }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Middleware checks:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SELECT * FROM http_idempotency      â”‚
â”‚  WHERE tenantId = '...'              â”‚
â”‚    AND method = 'POST'               â”‚
â”‚    AND path = '/transfers'           â”‚
â”‚    AND bodyHash = 'sha256...'        â”‚
â”‚  â†’ NOT FOUND                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Process normally:
â†’ Create outbox command
â†’ Save idempotency record
â†’ Return 202 Accepted


Request 2 (10:30:00.050) - 50ms later!
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /transfers                     â”‚
â”‚  X-Idempotency-Key: "abc-123"        â”‚
â”‚  (same body)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Middleware checks:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SELECT * FROM http_idempotency      â”‚
â”‚  â†’ FOUND! (from Request 1)           â”‚
â”‚  {                                   â”‚
â”‚    responseBody: {                   â”‚
â”‚      requestId: "...",               â”‚
â”‚      status: "pending"               â”‚
â”‚    },                                â”‚
â”‚    statusCode: 202                   â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Return cached response:
â†’ Same response as Request 1
â†’ Command NOT created again! âœ“
â†’ Money transferred only ONCE! âœ“


HEALTH CHECK FAILURE DETECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Kubernetes readiness probe:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Every 10 seconds:                   â”‚
â”‚  GET /readyz                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Projector calculates lag:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Current blockchain block: 12350     â”‚
â”‚  Last processed block: 12345         â”‚
â”‚  Lag: 5 blocks Ã— 2s/block = 10s      â”‚
â”‚                                      â”‚
â”‚  Threshold: 30s                      â”‚
â”‚  Status: âœ“ READY (lag < threshold)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

If lag > 30s:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /readyz                         â”‚
â”‚  â†“                                   â”‚
â”‚  HTTP 503 Service Unavailable        â”‚
â”‚  {                                   â”‚
â”‚    "status": "not_ready",            â”‚
â”‚    "reason": "projection_lag_too_    â”‚
â”‚      high",                          â”‚
â”‚    "projectionLagMs": 35000          â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Kubernetes response:
â†’ Remove pod from load balancer
â†’ Stop sending traffic
â†’ Alert ops team

Once lag recovers:
â†’ /readyz returns 200
â†’ Pod added back to load balancer
â†’ Traffic resumes
```

---

## 6. Tech Stack Decision Tree

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WHY WE CHOSE EACH TECHNOLOGY                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PROGRAMMING LANGUAGE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Need: Backend API server
â”‚
â”œâ”€ JavaScript?
â”‚  â”œâ”€ âœ“ Pros: Simple, fast to develop
â”‚  â””â”€ âœ— Cons: No type safety, runtime errors
â”‚
â”œâ”€ TypeScript? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: Type safety, great IDE support
â”‚  â”œâ”€ âœ“ Pros: Catches bugs at compile time
â”‚  â”œâ”€ âœ“ Pros: JavaScript superset (can use JS libraries)
â”‚  â””â”€ âœ— Cons: Extra compilation step
â”‚
â”œâ”€ Python?
â”‚  â”œâ”€ âœ“ Pros: Great for data/ML, readable
â”‚  â””â”€ âœ— Cons: Slower, dynamic typing, GIL
â”‚
â”œâ”€ Go?
â”‚  â”œâ”€ âœ“ Pros: Fast, concurrent, compiled
â”‚  â””â”€ âœ— Cons: Verbose, smaller ecosystem
â”‚
â””â”€ Java?
   â”œâ”€ âœ“ Pros: Mature, strong typing, enterprise-ready
   â””â”€ âœ— Cons: Verbose, heavier runtime


HTTP FRAMEWORK
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Need: Handle HTTP requests efficiently
â”‚
â”œâ”€ Express.js? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: Simple, huge ecosystem, battle-tested
â”‚  â”œâ”€ âœ“ Pros: Flexible middleware system
â”‚  â””â”€ âœ— Cons: Not the fastest
â”‚
â”œâ”€ Fastify?
â”‚  â”œâ”€ âœ“ Pros: 2x faster than Express
â”‚  â””â”€ âœ— Cons: Smaller ecosystem, less familiar
â”‚
â”œâ”€ NestJS?
â”‚  â”œâ”€ âœ“ Pros: TypeScript-first, structured
â”‚  â””â”€ âœ— Cons: Steeper learning curve, opinionated
â”‚
â””â”€ Koa?
   â”œâ”€ âœ“ Pros: Modern async/await, lightweight
   â””â”€ âœ— Cons: Less middleware available


DATABASE
â”€â”€â”€â”€â”€â”€â”€â”€

Need: Store user data, transactions reliably
â”‚
â”œâ”€ PostgreSQL? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: ACID transactions (critical for money!)
â”‚  â”œâ”€ âœ“ Pros: Relational (complex queries)
â”‚  â”œâ”€ âœ“ Pros: JSON support (JSONB)
â”‚  â”œâ”€ âœ“ Pros: 30+ years mature
â”‚  â””â”€ âœ— Cons: Harder to scale horizontally
â”‚
â”œâ”€ MongoDB?
â”‚  â”œâ”€ âœ“ Pros: Flexible schema, scales easily
â”‚  â””â”€ âœ— Cons: Eventual consistency, no ACID by default
â”‚
â”œâ”€ MySQL?
â”‚  â”œâ”€ âœ“ Pros: Simple, popular
â”‚  â””â”€ âœ— Cons: Less features than PostgreSQL
â”‚
â””â”€ Redis?
   â”œâ”€ âœ“ Pros: Very fast (in-memory)
   â””â”€ âœ— Cons: Data can be lost, not for primary storage


ORM (Object-Relational Mapping)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Need: Type-safe database access
â”‚
â”œâ”€ Prisma? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: Best TypeScript integration
â”‚  â”œâ”€ âœ“ Pros: Auto-generated types
â”‚  â”œâ”€ âœ“ Pros: Great migrations
â”‚  â”œâ”€ âœ“ Pros: Excellent DX (Developer Experience)
â”‚  â””â”€ âœ— Cons: Some performance overhead
â”‚
â”œâ”€ TypeORM?
â”‚  â”œâ”€ âœ“ Pros: Mature, feature-rich
â”‚  â””â”€ âœ— Cons: Less type-safe, bugs
â”‚
â”œâ”€ Sequelize?
â”‚  â”œâ”€ âœ“ Pros: Popular, supports many DBs
â”‚  â””â”€ âœ— Cons: Poor TypeScript support
â”‚
â””â”€ Raw SQL?
   â”œâ”€ âœ“ Pros: Full control, fastest
   â””â”€ âœ— Cons: No type safety, SQL injection risk


MONOREPO TOOL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Need: Manage multiple packages in one repo
â”‚
â”œâ”€ Turborepo? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: Fast (caching)
â”‚  â”œâ”€ âœ“ Pros: Simple config
â”‚  â”œâ”€ âœ“ Pros: Great for TypeScript
â”‚  â””â”€ âœ— Cons: Newer (less mature)
â”‚
â”œâ”€ Lerna?
â”‚  â”œâ”€ âœ“ Pros: Mature, battle-tested
â”‚  â””â”€ âœ— Cons: Slower, more complex
â”‚
â”œâ”€ Nx?
â”‚  â”œâ”€ âœ“ Pros: Very powerful, many features
â”‚  â””â”€ âœ— Cons: Complex, opinionated
â”‚
â””â”€ pnpm workspaces?
   â”œâ”€ âœ“ Pros: Fast, efficient
   â””â”€ âœ— Cons: Need additional tools for tasks


LOGGER
â”€â”€â”€â”€â”€â”€

Need: Structured, performant logging
â”‚
â”œâ”€ Pino? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: Fastest (5-10x faster than Winston)
â”‚  â”œâ”€ âœ“ Pros: Low overhead
â”‚  â”œâ”€ âœ“ Pros: Structured JSON
â”‚  â””â”€ âœ— Cons: Less features than Winston
â”‚
â”œâ”€ Winston?
â”‚  â”œâ”€ âœ“ Pros: Feature-rich, transports
â”‚  â””â”€ âœ— Cons: Slower, higher overhead
â”‚
â””â”€ console.log?
   â”œâ”€ âœ“ Pros: Simple, built-in
   â””â”€ âœ— Cons: Not structured, no levels


VALIDATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Need: Validate environment variables & API inputs
â”‚
â”œâ”€ Zod? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: TypeScript-first
â”‚  â”œâ”€ âœ“ Pros: Runtime + compile-time types
â”‚  â”œâ”€ âœ“ Pros: Great error messages
â”‚  â””â”€ âœ— Cons: Newer library
â”‚
â”œâ”€ Joi?
â”‚  â”œâ”€ âœ“ Pros: Mature, feature-rich
â”‚  â””â”€ âœ— Cons: Not TypeScript-first
â”‚
â”œâ”€ Yup?
â”‚  â”œâ”€ âœ“ Pros: Simple, popular
â”‚  â””â”€ âœ— Cons: Less TypeScript support
â”‚
â””â”€ Class-validator?
   â”œâ”€ âœ“ Pros: Decorator-based
   â””â”€ âœ— Cons: Requires classes, more complex


BLOCKCHAIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Need: Private, permissioned blockchain
â”‚
â”œâ”€ Hyperledger Fabric? â† CHOSEN!
â”‚  â”œâ”€ âœ“ Pros: Enterprise-grade
â”‚  â”œâ”€ âœ“ Pros: Permissioned (know all participants)
â”‚  â”œâ”€ âœ“ Pros: Private (data not public)
â”‚  â”œâ”€ âœ“ Pros: Modular architecture
â”‚  â””â”€ âœ— Cons: Complex setup
â”‚
â”œâ”€ Ethereum?
â”‚  â”œâ”€ âœ“ Pros: Public, smart contracts
â”‚  â””â”€ âœ— Cons: Expensive gas fees, public data
â”‚
â”œâ”€ Corda?
â”‚  â”œâ”€ âœ“ Pros: Privacy-focused
â”‚  â””â”€ âœ— Cons: Smaller ecosystem
â”‚
â””â”€ Custom Blockchain?
   â”œâ”€ âœ“ Pros: Full control
   â””â”€ âœ— Cons: Months of development, security risks
```

---

**End of Visual Architecture Guide**

Use this document alongside the main learning guide to visualize how everything fits together!
