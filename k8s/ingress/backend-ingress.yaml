apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gx-backend-ingress
  namespace: backend-mainnet
  annotations:
    # Use cert-manager to automatically request Let's Encrypt certificate
    # Using staging for now due to prod issuer connectivity issue
    cert-manager.io/cluster-issuer: "letsencrypt-staging"

    # Skip self-check as cluster DNS cannot resolve external domain
    acme.cert-manager.io/http01-edit-in-place: "false"

    # Nginx-specific annotations
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"

    # CORS headers (if needed for web clients)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://gxcoin.money, https://www.gxcoin.money"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization, Content-Type, X-Idempotency-Key"

    # Rate limiting (additional layer on top of application-level)
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "5"

    # Real IP from Cloudflare
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"
    nginx.ingress.kubernetes.io/forwarded-for-header: "CF-Connecting-IP"
spec:
  ingressClassName: nginx

  tls:
  - hosts:
    - api.gxcoin.money
    secretName: gx-api-tls  # cert-manager will create this Secret

  rules:
  - host: api.gxcoin.money
    http:
      paths:
      # ============================================
      # IDENTITY SERVICE
      # ============================================
      - path: /api/v1/auth
        pathType: Prefix
        backend:
          service:
            name: svc-identity
            port:
              number: 3001

      - path: /api/v1/users
        pathType: Prefix
        backend:
          service:
            name: svc-identity
            port:
              number: 3001

      # ============================================
      # TOKENOMICS SERVICE
      # ============================================
      - path: /api/v1/wallets
        pathType: Prefix
        backend:
          service:
            name: svc-tokenomics
            port:
              number: 3003

      - path: /api/v1/transactions
        pathType: Prefix
        backend:
          service:
            name: svc-tokenomics
            port:
              number: 3003

      - path: /api/v1/balances
        pathType: Prefix
        backend:
          service:
            name: svc-tokenomics
            port:
              number: 3003

      # ============================================
      # ORGANIZATION SERVICE
      # ============================================
      - path: /api/v1/organizations
        pathType: Prefix
        backend:
          service:
            name: svc-organization
            port:
              number: 3004

      # ============================================
      # LOANPOOL SERVICE
      # ============================================
      - path: /api/v1/loans
        pathType: Prefix
        backend:
          service:
            name: svc-loanpool
            port:
              number: 3005

      # ============================================
      # GOVERNANCE SERVICE
      # ============================================
      - path: /api/v1/proposals
        pathType: Prefix
        backend:
          service:
            name: svc-governance
            port:
              number: 3006

      - path: /api/v1/votes
        pathType: Prefix
        backend:
          service:
            name: svc-governance
            port:
              number: 3006

      # ============================================
      # ADMIN SERVICE
      # ============================================
      - path: /api/v1/admin
        pathType: Prefix
        backend:
          service:
            name: svc-admin
            port:
              number: 3002

      # ============================================
      # TAX SERVICE
      # ============================================
      - path: /api/v1/fees
        pathType: Prefix
        backend:
          service:
            name: svc-tax
            port:
              number: 3007

      - path: /api/v1/velocity-tax
        pathType: Prefix
        backend:
          service:
            name: svc-tax
            port:
              number: 3007

      # ============================================
      # HEALTH CHECK (PUBLIC)
      # ============================================
      - path: /health
        pathType: Exact
        backend:
          service:
            name: svc-identity  # Can use any service
            port:
              number: 3001
