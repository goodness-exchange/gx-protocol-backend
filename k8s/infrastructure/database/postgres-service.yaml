---
# Headless Service for StatefulSet (required for stable network identities)
apiVersion: v1
kind: Service
metadata:
  name: postgres-headless
  namespace: backend-mainnet
  labels:
    app: postgres
    component: database
    tier: infrastructure
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app: postgres
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
    protocol: TCP
  publishNotReadyAddresses: true

---
# Primary Service (read/write)
# Points to postgres-0 (first replica is always primary)
apiVersion: v1
kind: Service
metadata:
  name: postgres-primary
  namespace: backend-mainnet
  labels:
    app: postgres
    component: database
    tier: infrastructure
    role: primary
spec:
  type: ClusterIP
  selector:
    app: postgres
    statefulset.kubernetes.io/pod-name: postgres-0
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
    protocol: TCP

---
# General Service (load-balanced across all replicas)
# Can be used for read queries
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: backend-mainnet
  labels:
    app: postgres
    component: database
    tier: infrastructure
spec:
  type: ClusterIP
  selector:
    app: postgres
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
    protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

---
# External Service (NodePort for administrative access)
# Use with caution - should be firewalled in production
apiVersion: v1
kind: Service
metadata:
  name: postgres-external
  namespace: backend-mainnet
  labels:
    app: postgres
    component: database
    tier: infrastructure
  annotations:
    description: "External access for database administration only. Should be restricted by NetworkPolicy."
spec:
  type: NodePort
  selector:
    app: postgres
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
    nodePort: 30432
    protocol: TCP
